<script>
    const containerSize = 126;

    // parent.postMessage({ pluginMessage: 'anything here' }, '*');

    onmessage = (event) => {
        //   console.log("got this from the plugin code", event.data.pluginMessage)
        if (event.data.pluginMessage.type === 'preview') {
            preview(event.data.pluginMessage);
        }
        if (event.data.pluginMessage.type === 'large_image') {
            draw(event.data.pluginMessage);
        }

        if (event.data.pluginMessage.type === 'showConfirmDialog') {
            confirmDialog(event.data.pluginMessage);
        }

        if (event.data.pluginMessage.type === 'updateTransformCheckbox') {
            updateTransformCheckbox(event.data.pluginMessage);
        }

    }

    function preview(message) {
        var imgData = message.bytes;
        var aspect = message.aspect;
        var preview = document.getElementById("thumbnailimage");
        let blob = new Blob([imgData], { type: 'image/png'});
        let bloburl = URL.createObjectURL(blob);

        
        preview.style.opacity= 0.7;
        preview.src = bloburl;
        aspectFitElement(preview, aspect);
        
        let dragimage = document.getElementById("dragimage")
        dragimage.style.opacity = 0.0;
        // dragimage.src = "";

        // var img = document.getElementById("dragimage").src = "";
        
        setTimeout(function() {
        parent.postMessage({ pluginMessage: { name: "getLargeImage" } }, '*');
        }, 100);
    }

    function draw(message) {
        
        var imgData = message.bytes;
        var aspect = message.aspect;

        var img = document.getElementById("dragimage");
        let blob = new Blob([imgData], { type: 'image/png' });

        let tempFile = new File([imgData], "image.png", { type: 'image/png' });
        // console.log(tempFile);
        let bloburl = URL.createObjectURL(tempFile);
        // console.log(bloburl);
        let link = document.getElementById("previewdownload");
            link.href = bloburl;
            link.download = "filename";

        img.src = bloburl;
  
        aspectFitElement(img, aspect);
       

        var preview = document.getElementById("thumbnailimage");
        preview.style.opacity= 0.0;
        // preview.style.backgroundImage = "";
        dragimage.style.opacity = 1.0;

    }

    function aspectFitElement(el, aspect){
        if (aspect >= 1) {
            el.style.height = `${(containerSize / aspect)}px`;
            el.style.top = `${(containerSize - containerSize / aspect) / 2}px`;
            el.style.left = '0px'
            el.style.width = `${containerSize}px`
        } else {
            el.style.height = `${containerSize}px`
            el.style.left = `${(1 - aspect) * containerSize / 2}px`;
            el.style.width = `${(containerSize * aspect)}px`;
            el.style.top= '0px'
        }
        return el;
    }
    function confirmDialog(message) {
        var confirmation =  window.confirm(message.message);
        parent.postMessage({ pluginMessage: confirmation}, '*');

    }

    function updateTransformCheckbox(message){
        console.log("UPdating checkboxâ€¦" + message.message);
        document.getElementById("preserveTransforms").checked = message.message

    }
</script>

<style>
    .actions {
        width: 126px;
        display: flex;
        flex-direction: column;
    }

    .actions button {
        text-align: center;
        display: block;
        flex-grow: 1;
        margin-bottom: 4px;
    }

    .actions a:hover {
        background-color: #DBDBDB
    }

    .actions label {
        text-align: left;
        display: block;
        flex-grow: 1;
    }

    .actions input[type=checkbox] {
        margin-right: 6px;
    } 

    .actions>* {
        cursor: pointer;
    }
    #previewThumbnail {
        opacity: 1;
        text-align: center;
        overflow: hidden;
        display: block;
        width: 126px;
        height: 126px;
        background-repeat: no-repeat;
        background-size: contain;
        background-position: 50% 50%;
        transition-property: opacity;
        transition-duration: .2s;
        position: relative;
       
    }

    #dragimage, #thumbnailimage {
        opacity: 0;
        transition-property: opacity;
        transition-duration: .2s;
        position: absolute;
        cursor: grab;
    } 

    #thumbnailimage {
        z-index: 0;
    }

    #dragimage {
        z-index: 1;
    }
</style>
<link rel="stylesheet" href="https://static.figma.com/api/figma-extension-api-0.0.1.css">
<div id="previewThumbnail" ><img draggable="true" id="dragimage" /><img draggable="false" id="thumbnailimage"/></div>
<a id='previewdownload'></a>

<p class="actions">
    <button id="setLayer" class="action">Set Source Layer</button>
    <button id="replaceLayers" class="replaceLayers action">Replace Layer(s)</button>
    <label for="preserveTransforms" title="Preserve rotation and scale (scale is preserved for component instances only)."><input  class="action" type="checkbox" checked class="transforms" id="preserveTransforms">Keep Transforms</label>
</p>



<script>
    document.getElementById("dragimage").addEventListener('dragstart', e => {
        let el = document.getElementById("dragimage");
        e.dataTransfer.setDragImage(document.getElementById("previewThumbnail"), 63, 63);
        e.dataTransfer.dropEffect = "copy";
       e.dataTransfer.effectAllowed = "copy";

    })
    document.querySelectorAll('.action').forEach(item => {
        item.addEventListener('click', e => {
            let preserveTransforms = document.getElementById("preserveTransforms").checked;
            parent.postMessage({ pluginMessage: { name: e.target.id, preserveTransforms: preserveTransforms } }, '*');
        });
    });
   
</script>